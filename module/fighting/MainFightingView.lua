--游戏中的viewmodule("MainFightingView", package.seeall)-- require "script/module/fighting/PlistToSpriteManager"require "script/module/fighting/Cards"require "script/network/WebSocketClient"require "script/module/fighting/FightingData"require "script/module/public/ShowNotice"require "script/model/DataCache"require "script/module/config/AudioHelper"  require "script/module/public/UIHelper"local cjson = require "cjson"-- 标志刚开局local start = true-- 资源文件setAnchorPointlocal activity_list = "n_ui/gaming_1.json" local m_fnGetWidget = g_fnGetWidgetByName-- 牌旋转角度local rotate = 23-- 最后一张牌和别的牌的间距local margin = 30-- 记录下打牌的轮数local playCount = 0-- 左边打牌轮数local leftCount = 0-- 右边打牌轮数local rightCount = 0-- 上面打牌轮数local upCount = 0-- 每行多少个麻将local number = 10-- 选中的序号local choosenIndex = 0-- 是否可以出牌local canOut = false-- 牌移动时间local moveDuration = 0.2-- 聊天按钮local btnChat-- 倒计时时间local time = 15local newNamelocal tpPath = "n_ui/cards.plist"local ttPath = "n_ui/cards.png"local schedulerId  -- 定时器的idlocal left_timerlocal right_timerlocal up_timer     --北  2local bottom_timer -- 南  4local labn_bottomlocal labn_uplocal labn_right   local labn_left local back  local tfdLetfDirlocal tfdRightDirlocal tfdUpDirlocal tfdBottomDirlocal btnEat local btnPeng local btnTing local btnHulocal tishi = {} -- 放过和 打牌local btnGanglocal btnGuo-- local layLeftBackChat,layUpBackChat,layRightBackChat-- local lay_bottom_user_talk-- local tfd_bottom_user_chatlocal tfdrightuserlocal tfdupuserlocal tfdleftuserlocal lay_baopailocal img_baopai_info-- local img_left_user,img_right_user,img_up_userlocal chatTable = {}-- 储存自己的所有手牌local cardsArray = {}local baseArray = {}local faceNameArray = {}local layoutArray = {}local isHasTingCards = {}-- 储存四人的信息local playerInfoTable = {}local tfdTimerOne ,tfdTimerTwo,tfdTimerThree,tfdTimerFourlocal imgTimerOne , imgTimerTwo ,imgTimerThree,imgTimerFour,labnCenterlocal otherPlayerCardVms-- 万 c_11~c_19-- 筒 c_21~c_29-- 条 c_31~c_39-- 东 c_41-- 南 c_42-- 西 c_43-- 北 c_44-- 中 c_45-- 储存服务器返回的牌数组 条 筒 万local myCards-- 自己庄家标记local zhuang = false-- 庄家位置local zhuangPosition -- 自己的位置local myPosition-- 出牌人的位置local outPosition-- 出的牌local otherOutCards-- 牌的对照表local cardsTable = {["c_31.png"]=0,["c_32.png"]=1,["c_33.png"]=2,["c_34.png"]=3,["c_35.png"]=4,["c_36.png"]=5,["c_37.png"]=6,["c_38.png"]=7,["c_39.png"]=8,["c_21.png"]=10,["c_22.png"]=11,["c_23.png"]=12,["c_24.png"]=13,["c_25.png"]=14,["c_26.png"]=15,["c_27.png"]=16,["c_28.png"]=17,["c_29.png"]=18,["c_11.png"]=20,["c_12.png"]=21,["c_13.png"]=22,["c_14.png"]=23,["c_15.png"]=24,["c_16.png"]=25,["c_17.png"]=26,["c_18.png"]=27,["c_19.png"]=28,["c_41.png"]=30,["c_42.png"]=31,["c_43.png"]=32,["c_44.png"]=33,["c_45.png"]=34}-- 胡完之后的过标志local huGuoFlag = false-- 有特殊操作的标志位local specialFlag = false-- 吃听、碰听之后的标志local tingDaFlag = false-- 受暗杠影响的牌local ingangEffects-- 取出受暗杠影响的牌local ingangCardsArray = {}-- 取出受吃影响的牌local chiEffectCard-- 处于被吃状态的牌的数组local chiCardsArray = {}local isTing  -- 取出受碰影响的牌local pengEffectCard-- 处于被碰状态的牌的数组local pengCardsArray = {}-- 其他人吃碰杠影响的牌local rightChiArray = {}local upChiArray = {}local leftChiArray = {}local rightPengArray = {}local upPengArray = {}local leftPengArray = {}local newOnelocal rightGangArray = {}local upGangArray = {}local leftGangArray = {}local btnChiting local btnPentTinglocal btnTingdalocal lay_letf_user_talk  -- 左面的显示内容local layRightUserTalk -- 右边的人说话显示的内容local layUpUserTalk -- 上面的那个人说话要显示的内容-- 别人打出的牌local layLastOutTable = {}-- 听牌状态local tbZhuangtai = {}-- 别人听牌状态local otherTing = {}local function init( ... )    -- bodyend function playItemAnimation(aniImg)  local m_arAni1 = UIHelper.createArmatureNode({    filePath = "images/effect/item_show/item_show.ExportJson",    animationName = "item_show",    loop = -1,  })  aniImg:removeNodeByTag(12345)  aniImg:addNode(m_arAni1,-100,12345)endfunction reloadSource()    local plistCache = CCSpriteFrameCache:sharedSpriteFrameCache()    plistCache:addSpriteFramesWithFile(tpPath,ttPath)    require "script/module/fighting/SpriteFramesManager"    SpriteFramesManager.add(tpPath,ttPath)endfunction getWord( word )   local cache = CCSpriteFrameCache:sharedSpriteFrameCache()    local frameData = cache:spriteFrameByName(word)    if(word == nil or frameData == nil) then       reloadSource()          frameData = cache:spriteFrameByName(word)          if(word == nil or frameData == nil) then             error("CCSpriteFrame can't find :" .. word)           end    end -- if end    local frameSprite = CCSprite:create()        frameSprite:setDisplayFrame(frameData)    frameSprite:setAnchorPoint(ccp(0.5, 0.5))    frameSprite:setCascadeOpacityEnabled(true)         return frameSpriteend-- 最底的layerlocal layBack-- 下面打出的牌的layerlocal lay_out_bottom-- 右边local lay_out_right-- 上面local lay_out_up-- 左边local lay_out_left-- 上方打出底牌local upBasefunction clearLayer()  local clearTable = {}  for i=1,14 do    clearTable.layName = "lay_bottom_" .. i    -- print("layName"..layName)    clearTable.lay_bottom = m_fnGetWidget(layBack,clearTable.layName)    clearTable.lay_bottom:removeAllNodes()    clearTable.leftLayerName = "lay_left_"..i    clearTable.leftLayer = m_fnGetWidget(layBack,clearTable.leftLayerName)    clearTable.leftLayer:removeAllNodes()    clearTable.upLayerName = "lay_up_"..i    clearTable.upLayer = m_fnGetWidget(layBack,clearTable.upLayerName)    clearTable.upLayer:removeAllNodes()    clearTable.rightLayerName = "lay_right_"..i    clearTable.rightLayer = m_fnGetWidget(layBack,clearTable.rightLayerName)    clearTable.rightLayer:removeAllNodes()  end  lay_out_bottom:removeAllNodes()  lay_out_right:removeAllNodes()  lay_out_up:removeAllNodes()  lay_out_left:removeAllNodes()  img_right_user:setVisible(false)  tfdrightuser:setVisible(false)  img_up_user:setVisible(false)  tfdupuser:setVisible(false)  img_left_user:setVisible(false)  tfdleftuser:setVisible(false)  tbZhuangtai.img_zhuangtai_zhuang_bottom:setVisible(false)  tbZhuangtai.img_zhuangtai_zhuang_right:setVisible(false)  tbZhuangtai.img_zhuangtai_zhuang_up:setVisible(false)  tbZhuangtai.img_zhuangtai_zhuang_left:setVisible(false)  tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(false)  tbZhuangtai.img_zhuangtai_ting_up:setVisible(false)  tbZhuangtai.img_zhuangtai_ting_right:setVisible(false)  tbZhuangtai.img_zhuangtai_ting_left:setVisible(false)endfunction clearData( ... )    cardsArray = {}    baseArray = {}    faceNameArray = {}    isHasTingCards = {}    playerInfoTable = {}    otherPlayerCardVms = {}    playCount = 0    leftCount = 0    rightCount = 0    upCount = 0    choosenIndex = 0    canOut = false    myCards = nil    zhuang = false    zhuangPosition = nil    myPosition = nil    outPosition = nil    otherOutCards = nil    huGuoFlag = false    specialFlag = false    tingDaFlag = false    ingangEffects = {}    ingangCardsArray = {}    chiEffectCard = {}    chiCardsArray = {}    isTing = false    pengEffectCard = {}    pengCardsArray = {}    rightChiArray = {}    upChiArray = {}    leftChiArray = {}    rightPengArray = {}    upPengArray = {}    leftPengArray = {}    newOne = nil    rightGangArray = {}    upGangArray = {}    leftGangArray = {}    otherTing = {}    start = trueendfunction destroy(...)    clearData()    package.loaded["MainFightingView"] = nilendfunction moduleName()  return "MainFightingView"end-- 相对坐标转化成世界坐标function getProcessPos( layout )  local parentNode = layout:getParent()  return parentNode:convertToWorldSpace(ccp(layout:getPositionX(),layout:getPositionY()))end-- 根据牌的序号转成牌的图片名字-- @param num 牌的序号，1~34-- 返回图片的名称function changeCardName( num ,direct)  local imageName  local row = math.floor((num+1) / 10)  local col = (num+1) % 10  if col ~= 0 then    if row == 0 then       -- 第一行，条 c_31~c_39      imageName = "c_3"..col..".png"      if direct == 1 then        -- 右边        imageName = "c_r_3"..col..".png"      end      if direct == 3 then        -- 左边        imageName = "c_l_3"..col..".png"      end    end    if row == 1 then      -- 第二行，筒 c_21~c_29      imageName = "c_2"..col..".png"      if direct == 1 then        -- 右边        imageName = "c_r_2"..col..".png"      end      if direct == 3 then        -- 左边        imageName = "c_l_2"..col..".png"      end    end    if row == 2 then      -- 第三行 万 c_11~c_19      imageName = "c_1"..col..".png"      if direct == 1 then        -- 右边        imageName = "c_r_1"..col..".png"      end      if direct == 3 then        -- 左边        imageName = "c_l_1"..col..".png"      end    end    if row == 3 then      -- 第四行      imageName = "c_4"..col..".png"      if direct == 1 then        -- 右边        imageName = "c_r_4"..col..".png"      end      if direct == 3 then        -- 左边        imageName = "c_l_4"..col..".png"      end    end  end  return imageNameend-- 把牌塞进数组-- @param flag 标志，用来表示是什么特殊操作function putInArray(num,curName,k,flag)  for i=1,num do    -- 牌转成Sprite    local sprite    if isTing then      sprite = getWord("b_07.png")      local sprites = CCSprite:create("n_ui/zhengzhao.png")      sprites:setPosition(ccp(sprites:getContentSize().width/2+7,sprites:getContentSize().height*.5+5))       sprite:addChild(sprites,1000)    else      sprite = getWord("b_04.png")    end          local face = getWord(curName)     table.insert(faceNameArray,k,curName)    table.insert(cardsArray,k,face)    table.insert(baseArray,k,sprite)    k = k + 1    -- else    --   if flag == "inGang" then    --     -- 是暗杠的话，放一个倒扣的牌    --     local sprite = getWord("b_06.png")    --     table.insert(faceNameArray,k,"empty")    --     table.insert(cardsArray,k,"empty")    --     table.insert(baseArray,k,sprite)    --     k = k + 1    --   end    -- end    print("一共有"..#cardsArray.."张牌")  endend-- 解析服务器返回的牌数组function translateCards()    for i=1,#cardsArray do      local tempSprite = baseArray[i]      local tempFace = cardsArray[i]      if tempFace ~= "empty" then        tempFace:removeFromParentAndCleanup(true)      end      tempSprite:removeFromParentAndCleanup(true)    end    faceNameArray = {}    cardsArray = {}    baseArray = {}    -- 先将吃影响的牌单独处理    if chiCardsArray ~= nil then      for i=1,#chiCardsArray do        local tempChiCards = chiCardsArray[i]        for j=1,3 do          -- 把每张牌转成图片名称          local imageName = changeCardName(tempChiCards[j])          -- 存进数组          local sprite = getWord("b_07.png")           local sprites = CCSprite:create("n_ui/zhengzhao.png")          sprites:setPosition(ccp(sprite:getContentSize().width/2,sprite:getContentSize().height*.5 -8))          -- sprites:setPosition(sprite:getPosition())          sprite:addChild(sprites,100)          local face = getWord(imageName)          table.insert(cardsArray,j,face)          table.insert(baseArray,j,sprite)        end      end    end    -- 再将碰影响的牌单独处理    if pengCardsArray ~= nil then      for i=1,#pengCardsArray do        local tempPengCards = pengCardsArray[i]        for j=1,3 do          -- 把每张牌转成图片名称          local imageName = changeCardName(tempPengCards[j])          -- 存进数组          local sprite = getWord("b_07.png")           local sprites = CCSprite:create("n_ui/zhengzhao.png")          sprites:setPosition(ccp(sprite:getContentSize().width/2,sprite:getContentSize().height*.5 -8))          -- sprites:setPosition(sprite:getPosition())          sprite:addChild(sprites,100)          local face = getWord(imageName)          table.insert(cardsArray,j,face)          table.insert(baseArray,j,sprite)        end      end    end    -- 还有杠影响的牌单独处理    if ingangCardsArray ~= nil then      for i=1,#ingangCardsArray do        local tempGangCards = ingangCardsArray[i]        for j=1,4 do          -- 把每张牌转成图片名称          local imageName = changeCardName(tempGangCards[j])          -- 存进数组          local sprite = getWord("b_07.png")           local sprites = CCSprite:create("n_ui/zhengzhao.png")          sprites:setPosition(ccp(sprite:getContentSize().width/2,sprite:getContentSize().height*.5 -8))         --  sprites:setPosition(sprite:getPosition())          sprite:addChild(sprites,100)          local face = getWord(imageName)          table.insert(cardsArray,j,face)          table.insert(baseArray,j,sprite)        end      end    end    print("吃了"..#cardsArray.."张牌")    local k = #cardsArray+1    local currentName    for i=1,37 do      local row = math.floor(i / 10)      local col = i % 10      local num = myCards[i]      -- print("num "..num)      -- print("col "..col)      -- print("row "..row)     -- 去除中间分隔的"0"     if col ~= 0 then      if row == 0 then         -- 第一行，条 c_31~c_39        if num >= 1 then           currentName = "c_3"..col..".png"        end      end      if row == 1 then        -- 第二行，筒 c_21~c_29        if num >= 1 then          currentName = "c_2"..col..".png"        end      end      if row == 2 then        -- 第三行 万 c_11~c_19        if num >= 1 then          currentName = "c_1"..col..".png"        end      end      if row == 3 then        -- 第四行        if num >= 1 then          currentName = "c_4"..col..".png"        end      end        putInArray(num,currentName,k)        k = k + num        currentName = nil      -- end     end    end    -- local nameArray = cjson.encode(faceNameArray)    -- print(nameArray)    if newOne ~= nil then      print("听牌时候摸到的牌 "..newName)      table.insert(faceNameArray,#faceNameArray+1,newName)      table.insert(cardsArray,#cardsArray+1,newOne)      local tempBase = getWord("b_04.png")      table.insert(baseArray,#baseArray+1,tempBase)    else         end    print("cardsArray count "..#cardsArray)    -- newOne = nilend-- 处理其他方向的特殊操作function performOtherSpecial(firstArray, secondArray, direction)  if firstArray ~= nil then    -- 吃的牌    for i=1,#firstArray do      local temp = firstArray[i]      for j=1,#temp do        local tempCard = temp[j]        local faceName = changeCardName(tempCard, direction)        print("faceName "..faceName)        local tempFace = getWord(faceName)        table.insert(secondArray,j,tempFace)      end    end  endend-- 非正面添加麻将牌function setupLayer(baseLayer, preName, spriteName, rotate, direction)  -- 先把吃碰杠的牌放好  local specialArray = {}  if direction ~= nil then    if direction == 1 then      print("---111---")      -- if otherTing.rightTing == true then      --   print("---111---")      --   spriteName = "b_01.png"      -- else        -- 右边        -- 吃的牌        performOtherSpecial(rightChiArray, specialArray,1)        -- 碰的牌        performOtherSpecial(rightPengArray,specialArray,1)        -- 杠的牌        performOtherSpecial(rightGangArray,specialArray,1)      -- end    end    if direction == 2 then      print("---222---")      -- if otherTing.upTing == true then      --   print("---222---")      --   spriteName = "b_06.png"      -- else        -- 上边        -- 吃的牌        performOtherSpecial(upChiArray,specialArray)        -- 碰的牌        performOtherSpecial(upPengArray,specialArray)        -- 杠的牌        performOtherSpecial(upGangArray,specialArray)      -- end    end    if direction == 3 then      print("---333---")      -- if otherTing.leftTing == true then      --   print("---333---")      --   spriteName = "b_01_2.png"      -- else        -- 左边        -- 吃的牌        performOtherSpecial(leftChiArray,specialArray,3)        -- 碰的牌        performOtherSpecial(leftPengArray,specialArray,3)        -- 杠的牌        performOtherSpecial(leftGangArray,specialArray,3)      -- end    end  end  -- 特殊牌的总长  local tempNumber = #specialArray  print("特殊牌长"..tempNumber)  if tempNumber > 0 then    for i = 1, tempNumber do      local layName = preName .. "_" .. i      -- print("layName11 "..layName)      local lay_up = m_fnGetWidget(baseLayer,layName)      lay_up:removeAllNodes()      local baseName      if direction == 1 then        -- 右边        baseName = "b_02.png"      end      if direction == 2 then        -- 上边        baseName = "b_07.png"      end      if direction == 3 then        -- 左边        baseName = "b_02_2.png"      end      local base = getWord(baseName)      base:setRotation(rotate)      base:setPosition(ccp(lay_up:getContentSize().width/2,lay_up:getContentSize().height*.5))      lay_up:addNode(base)      local face = specialArray[i]      local margin      if direction == 2 then        margin = 0      end      if direction == 1 or direction == 3 then        margin = 15      end      if direction == 2 then        face:setScale(0.8)        base:setScale(1.2)      else        face:setRotation(rotate)        face:setScale(1.5)        base:setScale(1.7)      end      face:setPosition(ccp(lay_up:getContentSize().width/2,lay_up:getContentSize().height*.5+margin))      -- face:setRotation(rotate)      lay_up:addNode(face)    end  end  print("正常的牌")  for i = tempNumber+1,13 do    local layName = preName .. "_" .. i    -- print("layName22 "..layName)    -- print(layName)    local lay_up = m_fnGetWidget(baseLayer,layName)    lay_up:removeAllNodes()    if direction == 1 then      -- 右边      if otherTing.rightTing == true then        spriteName = "b_01.png"      end    end    if direction == 2 then      -- 上边      if otherTing.upTing == true then        spriteName = "b_06.png"      end    end    if direction == 3 then      -- 左边      if otherTing.leftTing == true then        spriteName = "b_01_2.png"      end    end    local sprite = getWord(spriteName)    if direction == 2 then      sprite:setScale(1.2)    else      sprite:setScale(1.4)      if otherTing.rightTing == true or otherTing.leftTing == true then        sprite:setScale(1.6)      end    end    sprite:setPosition(ccp(lay_up:getContentSize().width/2,lay_up:getContentSize().height*.5))    sprite:setRotation(rotate)    lay_up:addNode(sprite)  endend-- 创建刚打出去的bottom麻将function createOutBottom(layBack)  -- local lay_out_bottom = m_fnGetWidget(layBack, "lay_out_bottom")  local sprite = getWord("b_10.png")  local face = choosenFace  if lay_out_bottom == nil then    print("lay_out_bottom是空的--227")  end  return ccp(getProcessPos(lay_out_bottom).x+lay_out_bottom:getContentSize().width/2, getProcessPos(lay_out_bottom).y+lay_out_bottom:getContentSize().height/2)endlocal cardsStandUp = {}-- 让现有的某一张牌站起来function standupCard( card ,flag)  local cardName = changeCardName(card)  print("cardName"..cardName)  -- print("--- "..cjson.encode(faceNameArray))  local count  for i=1,#faceNameArray do    if faceNameArray[i] == cardName then      count = i      break    end  end  if flag == 1 then    count = count + 1  end  if flag == 2 then    count = count + 2  end  if count == nil then    return  end  print("count "..count)  print("cardsArray number ".. #cardsArray)  local sprite = baseArray[count]  local face = cardsArray[count]  local layout = layoutArray[count]  sprite:setPositionY(layout:getContentSize().height*.5+20)  face:setPositionY(layout:getContentSize().height*.5-20+20)endfunction standDownAll( ... )  for i=1,#cardsArray do    local sprite = baseArray[count]    local face = cardsArray[count]    local layout = layoutArray[count]    sprite:setPositionY(layout:getContentSize().height*.5)    face:setPositionY(layout:getContentSize().height*.5-20)  endend-- 让现有的某一张牌站起来function standDownCard( card ,flag)  local cardName = changeCardName(card)  print("cardName"..cardName)  -- print("--- "..cjson.encode(faceNameArray))  local count  for i=1,#faceNameArray do    if faceNameArray[i] == cardName then      count = i      break    end  end  if flag == 1 then    count = count + 1  end  if flag == 2 then    count = count + 2  end  if count == nil then    return  end  print("count "..count)  print("cardsArray number ".. #cardsArray)  local sprite = baseArray[count]  local face = cardsArray[count]  local layout = layoutArray[count]  sprite:setPositionY(layout:getContentSize().height*.5 )  face:setPositionY(layout:getContentSize().height*.5-20 )end-- 判断table中是否含有某一元素function checkTable( table,member )  for i=1,#table do    if table[i] == member then      return true    end  endend-- 打出一张牌-- @param index 打出牌的序号function playOutCards( index,flag )  if index ~= nil then    print("进来了")    choosenIndex = index    choosenFace = cardsArray[index]    choosenSprite = baseArray[index]  end  print("打出第"..choosenIndex.."张")  -- print(cjson.encode(faceNameArray))  local oprationCards = {}  local key = faceNameArray[choosenIndex]  print("key--"..key)  local choosenNum = cardsTable[key]  oprationCards[1] = choosenNum  local sendData = nil   if flag == nil then     sendData = FightingData.sendOne(oprationCards)  else     sendData = FightingData.sendTingDaOne(oprationCards)  end  print("sendData--"..sendData)  WebSocketClient.request(sendData,function ( ret )    -- body    retFunction(ret)  end)  if choosenSprite == nil then    print("111为空")  end  -- body  -- 打出一张牌，剩下的牌排序  table.remove(faceNameArray,choosenIndex)  table.remove(cardsArray,choosenIndex)  table.remove(baseArray,choosenIndex)  -- 重新排列  print("last "..#cardsArray)  if choosenSprite == nil then    choosenSprite = newOne  end  -- 在lay_out_bottom中创建一个放大麻将  local position = createOutBottom(layBack)  -- 获取世界坐标  local spritePos = getProcessPos(choosenSprite)  local facePos = getProcessPos(choosenFace)  -- local layerPos = getProcessPos(choosenLayer)  -- 把原来的那个麻将从父视图中去除  choosenSprite:removeFromParentAndCleanup(true)  choosenFace:removeFromParentAndCleanup(true)  -- 在原位创建新的sprite和face  layBack:addNode(choosenSprite)  choosenSprite:setPosition(spritePos)  layBack:addNode(choosenFace)  choosenFace:setPosition(facePos)  -- -- 执行动画  -- -- 牌动画  local blinkArray = CCArray:create()  blinkArray:addObject(CCMoveTo:create(moveDuration ,position))  local actionMoveToCenter = CCSequence:create(blinkArray)  choosenSprite:runAction(actionMoveToCenter)  -- -- 牌面动画  local blinkArray1 = CCArray:create()  blinkArray1:addObject(CCMoveTo:create(moveDuration ,ccp(position.x,position.y - 20)))  local actionMoveToCenter1 = CCSequence:create(blinkArray1)  choosenFace:runAction(actionMoveToCenter1)    -- 经过一段时间的延迟  performWithDelay(layBack, function(...)    -- 移动到桌面上    print("移动到桌面上")    -- 1秒后消失    choosenSprite:removeFromParentAndCleanup(true)    choosenFace:removeFromParentAndCleanup(true)    -- 根据轮数创建    local card_out_bottom = getWord("b_07.png")    lay_out_bottom:setSize(CCSizeMake(card_out_bottom:getContentSize().width*10-150,card_out_bottom:getContentSize().height*2-100))    -- 下面打出牌的layer的width    local lay_out_bottom_width = lay_out_bottom:getContentSize().width    -- 下面打出牌的layer的height    local lay_out_bottom_height = lay_out_bottom:getContentSize().height    -- 获得行数和列数    local row = math.floor(playCount / number)    local col = playCount % number    -- 计算坐标    local posX = col * lay_out_bottom_width / number    local posY = lay_out_bottom_height - row * lay_out_bottom_height / 2    -- print("打出去---"..posX.."--"..posY)    card_out_bottom:setAnchorPoint(ccp(0, 1))    lay_out_bottom:addNode(card_out_bottom)    card_out_bottom:setPosition(ccp(posX, posY))    choosenFace:setAnchorPoint(ccp(0, 1))    choosenFace:setScale(0.5)    lay_out_bottom:addNode(choosenFace)    choosenFace:setPosition(ccp(posX+13, posY-28))    -- 牌落地的声音    AudioHelper.playEnterCopy()    for j=choosenIndex,#cardsArray do     local layNameNew = "lay_bottom_" .. j     local lay_bottomNew = m_fnGetWidget(layBack,layNameNew)     faceNew = cardsArray[j]     spriteNew = baseArray[j]     -- 排列麻将     -- 先将牌从原来的地方remove掉     -- print("牌的序号 "..j)     faceNew:removeFromParentAndCleanup(true)     spriteNew:removeFromParentAndCleanup(true)     -- 重新添加     lay_bottomNew:addNode(spriteNew)     spriteNew:setPosition(ccp(lay_bottomNew:getContentSize().width/2,lay_bottomNew:getContentSize().height*.5))     lay_bottomNew:addNode(faceNew)     faceNew:setPosition(ccp(lay_bottomNew:getContentSize().width/2,lay_bottomNew:getContentSize().height*.5 - 12))    end    -- 选中清空，防止下一次点击时扰乱    choosenSprite = nil    choosenFace = nil    -- -- 这一轮结束，下一轮    playCount = playCount + 1  end, 0.8)  -- timerOfwhichOne(layBack,1,time)endfunction hideAllBtn( )  btnEat:setVisible(false)   tishi.btnTishi:setVisible(false)  tishi.btnDa:setVisible(false)  btnEat:addTouchEventListener(function ( sender, eventType )             end)  btnPeng:setVisible(false)  btnTing:setVisible(false)  btnHu:setVisible(false)  btnGang:setVisible(false)  btnGuo:setVisible(false)  btnChiting:setVisible(false)   btnPentTing:setVisible(false)   btnTingda:setVisible(false)  tishi.btnDa:setTouchEnabled(false)  tishi.btnTishi:setTouchEnabled(false)  tishi.btnDa:addTouchEventListener(function ( sender, eventType )             end)  tishi.btnTishi:addTouchEventListener(function ( sender, eventType )             end)  btnChiting:addTouchEventListener(function ( sender, eventType )             end)  btnTingda:addTouchEventListener(function ( sender, eventType )             end)  btnPeng:addTouchEventListener(function ( sender, eventType )             end)  btnTing:addTouchEventListener(function ( sender, eventType )             end)  btnEat:addTouchEventListener(function ( sender, eventType )             end)  btnHu:addTouchEventListener(function ( sender, eventType )             end)  btnPentTing:addTouchEventListener(function ( sender, eventType )             end)  btnGang:addTouchEventListener(function ( sender, eventType )             end)  btnGuo:addTouchEventListener(function ( sender, eventType )             end)  -- timerOfwhichOne(layBack,1,time)end-- 听牌后，自己这边的牌全部放倒-- function sleepmyCards( )--   -- 先清空baseArray--   baseArray = {}--   -- 根据myCards的数量创建牌底--   for i=1,#myCards do--     local base = getWord("b_07.png")--     local sprites = CCSprite:create("n_ui/zhengzhao.png")--     sprites:setPosition(ccp(base:getContentSize().width/2,base:getContentSize().height*.5 -8)) --   --  sprites:setPosition(base:getPosition())--     base:addChild(sprites,1000)--    -- lay_bottom:addNode(sprites,100)--     table.insert(baseArray,i,base)--   end-- end-- 设置宝牌function setBaoPai( num )  local baoName = changeCardName(num)  local base = getWord("b_10.png")  local face = getWord(baoName)  -- base:setAnchorPoint(ccp(0,0))  -- face:setAnchorPoint(ccp(0,0))  -- lay_baopai:setAnchorPoint(ccp(0,0))  lay_baopai:removeAllNodes()  img_baopai_info:setVisible(false)  lay_baopai:addNode(base)  lay_baopai:addNode(face)  -- base:setPosition(ccp(0,0))  -- base:setScale(1.6)  -- face:setPosition(ccp(8,3))  -- face:setScale(1.2)end --显示一个控件，并指定显示的时间长度function showChatForTime( weight,maxTime )  local iSchedulerId  local time = 0  if (maxTime == nil) then    maxTime = 3  end  weight:setVisible(true)  local function iupdateScheduler( ... )           if time < maxTime then        time  = time +1      else        unscheduleScriptEntry(iSchedulerId)        time = 0        weight:setVisible(false)      end  end  iSchedulerId = CCDirector:sharedDirector():getScheduler():scheduleScriptFunc(iupdateScheduler, 1, false)end-- 消息处理function messageGet( ret )  -- 处理发消息  if ret["commandType"] == 940 then    print("收到了消息")    local messageTable = {}    messageTable.userId = ret["userId"]    messageTable.text = ret["msg"]    if otherPlayerCardVms[messageTable.userId] then      local temp = otherPlayerCardVms[messageTable.userId]      messageTable.position = temp["position"]    else      messageTable.position = myPosition    end    messageTable.value = (messageTable.position - myPosition + 4) % 4    print(messageTable.text)    if messageTable.value == 0 then      -- 我自己      chatTable.tfd_bottom_user_chat:setText(messageTable.text)      showChatForTime(chatTable.lay_bottom_user_talk)    elseif messageTable.value == 1 then      -- 右方      chatTable.layRightUserTalk:setText(messageTable.text)      showChatForTime(chatTable.layRightBackChat)    elseif messageTable.value == 2 then      -- 上分      chatTable.layUpUserTalk:setText(messageTable.text)      showChatForTime(chatTable.layUpBackChat)    elseif messageTable.value == 3 then      -- 左边      chatTable.lay_letf_user_talk:setText(messageTable.text)      showChatForTime(chatTable.layLeftBackChat)    end  endendfunction setUpOutCards( array, direction )  local outCardsTable = {}  if direction == 1 then    -- 右边    print("右边")    outCardsTable.baseName = "b_02.png"    outCardsTable.tempCount = rightCount    outCardsTable.layout = lay_out_right  end  if direction == 2 then    -- 上边    print("上边")    outCardsTable.baseName = "b_07.png"    outCardsTable.tempCount = upCount    outCardsTable.layout = lay_out_up  end  if direction == 3 then    -- 左边    print("左边")    outCardsTable.baseName = "b_02_2.png"    outCardsTable.tempCount = leftCount    outCardsTable.layout = lay_out_left  end  if direction == 4 then    -- 我这边    print("我这边")    outCardsTable.baseName = "b_07.png"    outCardsTable.tempCount = playCount    outCardsTable.layout = lay_out_bottom  end  if array ~= nil then    for i=1,#array do      print(array[i])      print(outCardsTable.tempCount)      outCardsTable.base = getWord(outCardsTable.baseName)      outCardsTable.faceName = changeCardName(array[i],direction)      print("有这张牌"..outCardsTable.faceName)      print("牌底"..outCardsTable.baseName)      outCardsTable.face = getWord(outCardsTable.faceName)      outCardsTable.layout:addNode(outCardsTable.base)      outCardsTable.layout:addNode(outCardsTable.face)      if direction == 4 then        outCardsTable.base:setZOrder(21+outCardsTable.tempCount)        outCardsTable.face:setZOrder(21+outCardsTable.tempCount)      else        outCardsTable.base:setZOrder(21-outCardsTable.tempCount)        outCardsTable.face:setZOrder(21-outCardsTable.tempCount)      end      outCardsTable.col = math.floor(outCardsTable.tempCount / 10)      outCardsTable.row = outCardsTable.tempCount % 10      if direction == 1 then        outCardsTable.posX = outCardsTable.col*68-8*outCardsTable.row-22*outCardsTable.col        outCardsTable.posY = outCardsTable.row*48-28*outCardsTable.row      end      if direction == 2 then        outCardsTable.row = math.floor(outCardsTable.tempCount / 10)        outCardsTable.col = outCardsTable.tempCount % 10        outCardsTable.posX = outCardsTable.col*48-5*outCardsTable.col        outCardsTable.posY = outCardsTable.row*68-20*outCardsTable.row        outCardsTable.face:setScale(0.7)      end      if direction == 3 then        outCardsTable.posX = outCardsTable.col*68+8*outCardsTable.row-22*outCardsTable.col        outCardsTable.posY = outCardsTable.row*48-28*outCardsTable.row      end      if direction == 4 then        outCardsTable.layout:setSize(CCSizeMake(outCardsTable.base:getContentSize().width*10-150,outCardsTable.base:getContentSize().height*2-100))        outCardsTable.base:setAnchorPoint(ccp(0,1))        outCardsTable.face:setAnchorPoint(ccp(0,1))        outCardsTable.row = math.floor(outCardsTable.tempCount / 10)        outCardsTable.col = outCardsTable.tempCount % 10        outCardsTable.posX = outCardsTable.col * outCardsTable.layout:getContentSize().width / number        outCardsTable.posY = outCardsTable.layout:getContentSize().height - outCardsTable.row * outCardsTable.layout:getContentSize().height / 2        outCardsTable.face:setScale(0.5)      end      outCardsTable.base:setPosition(ccp(outCardsTable.posX,outCardsTable.posY))      outCardsTable.face:setPosition(ccp(outCardsTable.posX,outCardsTable.posY))      if direction == 1 or direction == 3 then        outCardsTable.face:setPosition(ccp(outCardsTable.posX,outCardsTable.posY+10))      end      if direction == 4 then        outCardsTable.face:setPosition(ccp(outCardsTable.posX+13,outCardsTable.posY-28))      end      outCardsTable.tempCount = outCardsTable.tempCount + 1    end  end  if direction == 1 then    -- 右边    rightCount = outCardsTable.tempCount  end  if direction == 2 then    -- 上边    upCount = outCardsTable.tempCount  end  if direction == 3 then    -- 左边    leftCount = outCardsTable.tempCount  end  if direction == 4 then    -- 我这边    playCount = outCardsTable.tempCount  end  print("right "..rightCount)  print("up "..upCount)  print("left "..leftCount)  print("my "..playCount)end-- 回调方法function retFunction(ret)  -- body  playerInfoTable = {}  print("收到回调")  local data = ret["data"]  if data == nil then    print("data 为空")    return   end  local mycardVm = data["mycardVm"]  if data["commandType"] == 940 then    messageGet(data)    return  end  otherPlayerCardVms = data["otherPlayerCardVms"]  -- 续连判断  if data["commandType"] == 930 then    -- 打出的牌    local allOutCards = {}    data["commandType"] = data["currentCommandType"]    data["userId"] = data["currentUserId"]    -- 初始化界面    -- myCards = data["cards"]    allOutCards.myGang = mycardVm["outGangCards"]    chiCardsArray = mycardVm["eatSequences"]    pengCardsArray = mycardVm["pengSequences"]    if allOutCards.myGang ~= nil then      ingangCardsArray = allOutCards.myGang    end    myPosition = mycardVm["position"]    allOutCards.myOutCards = mycardVm["outCards"]    -- 其他人的吃碰杠    for k,v in pairs(otherPlayerCardVms) do      if v["position"] == nil then      else        local distance = (v["position"] - myPosition + 4) % 4        allOutCards.otherGang = v["outGangCards"]        if distance == 1 then          -- 右边          rightChiArray = v["eatSequences"]          rightPengArray = v["pengSequences"]          if allOutCards.otherGang ~= nil then            rightGangArray = allOutCards.otherGang          end          allOutCards.rightOutCards = v["outCards"]          if rightChiArray == nil then            rightChiArray = {}          end          if rightPengArray == nil then            rightPengArray = {}          end        end        if distance == 2 then          -- 上边          upChiArray = v["eatSequences"]          upPengArray = v["pengSequences"]          if allOutCards.otherGang ~= nil then            upGangArray = allOutCards.otherGang          end          allOutCards.upOutCards = v["outCards"]          if upChiArray == nil then            upChiArray = {}          end          if upPengArray == nil then            upPengArray = {}          end        end        if distance == 3 then          -- 左边          leftChiArray = v["eatSequences"]          leftPengArray = v["pengSequences"]          if allOutCards.otherGang ~= nil then            leftGangArray = allOutCards.otherGang          end          allOutCards.leftOutCards = v["outCards"]          if leftChiArray == nil then            leftChiArray = {}          end          if leftPengArray == nil then            leftPengArray = {}          end        end      end    end    -- 打出的牌排序    setUpOutCards(allOutCards.myOutCards,4)    setUpOutCards(allOutCards.rightOutCards,1)    setUpOutCards(allOutCards.upOutCards,2)    setUpOutCards(allOutCards.leftOutCards,3)  end  if data == nil then    return  end  -- 判断胡牌  if data["commandType"] == 206 then    print("有人胡了")    ShowNotice.showShellInfo("胡了")    FightingData.setHuResult(data)    require "script/module/fighting/MainFightingResultCtrl"    MainFightingResultCtrl.create()    return  end  -- local mycardVm = data["mycardVm"]  print("存了牌")  local baoPai = mycardVm["baoPai"]  if baoPai ~= nil then    setBaoPai(baoPai)  end  local tingDaOperateCards = data["operateCards"]  local commandTypeTips = data["commandTypeTips"]  table.insert(playerInfoTable,1,mycardVm)  local personCount = 0  -- otherPlayerCardVms = data["otherPlayerCardVms"]  if otherPlayerCardVms ~= nil then    personCount = retTableCount(otherPlayerCardVms)  end  if personCount ~= 3 then    -- 人还没满    print("已经有了".. personCount+1 .. "人")    local userArray = {}    for k,v in pairs(otherPlayerCardVms) do      table.insert(userArray,1,k)    end    -- print(cjson.encode(userArray))    if personCount == 1 then      local text = "玩家"..userArray[1]      img_right_user:setVisible(true)      tfdrightuser:setVisible(true)      tfdrightuser:setText(text)    end    if personCount == 2 then      local textTable = {}      textTable[1] = "玩家"..userArray[1]      textTable[2] = "玩家"..userArray[2]      img_right_user:setVisible(true)      tfdrightuser:setVisible(true)      img_up_user:setVisible(true)      tfdupuser:setVisible(true)      tfdrightuser:setText(textTable[1])      tfdupuser:setText(textTable[2])    end    return  end  if personCount == 3 then    btnChat:setVisible(true)    -- back:addTouchEventListener()    back:setTouchEnabled(false)    back:setVisible(false)    lay_baopai:setVisible(true)    img_right_user:setVisible(true)    tfdrightuser:setVisible(true)    img_up_user:setVisible(true)    tfdupuser:setVisible(true)    img_left_user:setVisible(true)    tfdleftuser:setVisible(true)    -- 记录下我的位置    myPosition = mycardVm["position"]    -- 开启定时器    -- 先计算出方向    local currentUserId = data["userId"]    local currentPos = otherPlayerCardVms[currentUserId]    if currentPos ~= nil then      local currentPosition = currentPos["position"]      print("currentPosition "..currentPosition)      local tempPos = currentPosition - myPosition      if tempPos == 1 or tempPos == -3 then        -- 右边        print("右边")        showDirection(1)      end      if tempPos == 2 or tempPos == -2 then        -- 上边        print("上边")        showDirection(2)      end      if tempPos == 3 or tempPos == -1 then        -- 左边        print("左边")        showDirection(3)      end    else      if data["nextUserId"] == nil or data["userId"] == data["nextUserId"] then        print("我这边")        showDirection(4)        canOut = true      end    end    if myCards == nil then    -- if data["commandType"] == 902      -- 收到初始牌      print("人满了，可以开始打牌了")      -- 个人信息排序      -- 按照position排序      table.sort(playerInfoTable,function(a,b)         if a ~= nil and b ~= nil then           return tonumber(a.position)<tonumber(b.position)         end       end)      -- 找到庄家位置      for i, v in pairs(playerInfoTable) do          local distance = (v.position - myPosition + 4) % 4        local textPos = {}        textPos.text = "玩家"..v["userId"]        textPos.pos = v["position"]        if distance == 1 then          -- local text = "玩家"..v["userId"]          -- local pos = v["position"]          -- print("text "..text)          tfdrightuser:setText(textPos.text)          tfdTimerThree:setText(FightingData.tranferCodeToWord(textPos.pos))          tfdrightuser:setFontSize(30)          -- layRightUserTalk:setTag(v["userId"])        end        if distance == 2 then          -- local text = "玩家"..v["userId"]          -- print("text "..text)          -- local pos = v["position"]          tfdTimerFour:setText(FightingData.tranferCodeToWord(textPos.pos))          tfdupuser:setText(textPos.text)          tfdupuser:setFontSize(30)          -- layUpUserTalk:setTag(v["userId"])        end        if distance == 3 then          -- local text = "玩家"..v["userId"]          -- print("text "..text)          -- local pos = v["position"]          tfdleftuser:setText(textPos.text)          tfdTimerOne:setText(FightingData.tranferCodeToWord(textPos.pos))           local pos = v["position"]          tfdleftuser:setFontSize(30)          -- lay_letf_user_talk:setTag(v["userId"])        end        if distance == 0 then          -- local pos = v["position"]           tfdTimerTwo:setText(FightingData.tranferCodeToWord(textPos.pos))        end        if v.zhuang == true then          -- 是庄家          zhuangPosition = v.position          if distance == 0 then            -- 我自己            tbZhuangtai.img_zhuangtai_zhuang_bottom:setVisible(true)          elseif distance == 1 then            -- 右方            tbZhuangtai.img_zhuangtai_zhuang_right:setVisible(true)          elseif distance == 2 then            -- 上分            tbZhuangtai.img_zhuangtai_zhuang_up:setVisible(true)          elseif distance == 3 then            -- 左边            tbZhuangtai.img_zhuangtai_zhuang_left:setVisible(true)          end        end      end      -- 牌布局      myCards = mycardVm["cards"]      zhuang = mycardVm["zhuang"]      if zhuang == true then        -- 我是庄家        -- 我摸牌        print("我是庄家")        WebSocketClient.request(FightingData.getOne(),function( ret )          -- body          print("收到了要打的牌")          -- canOut = true          retFunction(ret)        end)        return      end      translateCards()      setupCards(layBack)     end    if myCards ~= nil then      isTing = mycardVm["tinged"]      if isting then        tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)      else        tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(false)      end      -- if data["commandType"] == 107 then      myCards = mycardVm["cards"]      -- end      for k,v in pairs(otherPlayerCardVms) do        local otherTingFlag = v["tinged"]        if otherTingFlag == true then          -- 别人听了          local otherPos = v["position"]          local distance = (otherPos - myPosition + 4) % 4          if distance == 0 then            -- 我自己            tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)          elseif distance == 1 then            -- 右方            tbZhuangtai.img_zhuangtai_ting_right:setVisible(true)            otherTing.rightTing = true          elseif distance == 2 then            -- 上边            otherTing.upTing = true            tbZhuangtai.img_zhuangtai_ting_up:setVisible(true)          elseif distance == 3 then            -- 左边            otherTing.leftTing = true            tbZhuangtai.img_zhuangtai_ting_left:setVisible(true)          end        end      end      print("接着打牌")      if data["commandType"] == 106 then -- 吃听          myCards = mycardVm["cards"]          -- print(cjson.encode(myCards))          chiCardsArray = mycardVm["eatSequences"]          translateCards()          setupCards(layBack)          standupCard(tingDaOperateCards[1])          -- translateCards()          -- setupCards(layBack)            -- 吃听            ShowNotice.showShellInfo("吃听")            btnTingda:setVisible(true)            playItemAnimation(btnTingda)            btnTingda:addTouchEventListener(function ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                            specialFlag = false                                            -- 点击音效                                            AudioHelper.playBtnEffect("ting_01.mp3")                                            -- 取出碰的信息                                            local aryDatas = {}                                            aryDatas[1] = tingDaOperateCards[1]                                            local cardName = changeCardName(tingDaOperateCards[1])                                            print("cardName"..cardName)                                            local count                                            for i=1,#faceNameArray do                                              if faceNameArray[i] == cardName then                                                count = i                                                break                                              end                                            end                                            playOutCards(count,1)                                            hideAllBtn()                                        end                                  end)        end      if data["commandType"] == 107 then -- 碰听        myCards = mycardVm["cards"]        pengCardsArray = mycardVm["pengSequences"]        translateCards()        setupCards(layBack)        standupCard(tingDaOperateCards[1])        -- translateCards()        -- setupCards(layBack)        -- 听打        ShowNotice.showShellInfo("碰听")        btnTingda:setVisible(true)        playItemAnimation(btnTingda)        btnTingda:addTouchEventListener(function  ( sender, eventType)                                    if (eventType == TOUCH_EVENT_ENDED) then                                        specialFlag = false                                        tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                        -- 点击音效                                        AudioHelper.playBtnEffect("ting_01.mp3")                                        -- 取出碰的信息                                        local aryDatas = {}                                        aryDatas[1] = tingDaOperateCards[1]                                        local cardName = changeCardName(tingDaOperateCards[1])                                        print("cardName"..cardName)                                        local count                                        for i=1,#faceNameArray do                                          if faceNameArray[i] == cardName then                                            count = i                                            break                                          end                                        end                                         playOutCards(count,1)                                        hideAllBtn()                                    end                              end)       end      -- 特殊操作      if commandTypeTips ~= nil then        local specialUserId = data["nextUserId"]        local tempUserId = data["userId"]        print("commandTypeTips ~= nil and #commandTypeTips ~= 0")        if data["commandType"] == 100 then          -- 摸牌的时候出现听牌          -- 听牌          local ting = commandTypeTips["105"]          -- 过牌          local guo = commandTypeTips["207"]          if ting ~= nil  then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            myCards = mycardVm["cards"]            translateCards()            setupCards(layBack)             ShowNotice.showShellInfo("听牌")            btnTing:setVisible(true)            playItemAnimation(btnTing)            btnTing:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            specialFlag = false                                            -- 点击音效                                            -- AudioHelper.playBtnEffect("ting_01.mp3")                                            AudioHelper.playCommonEffect()                                            WebSocketClient.request(FightingData.operationCard("105",nil), function ( ret )                                              retFunction(ret)                                            end)                                            hideAllBtn()                                        end                                  end)          end          if guo ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 过牌            ShowNotice.showShellInfo("过牌")            btnGuo:setVisible(true)            playItemAnimation(btnGuo)            btnGuo:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            -- 什么操作都不做                                            hideAllBtn()                                            specialFlag = false                                            canOut = true                                            AudioHelper.playCommonEffect()                                            specialFlag = false                                            -- print("guoData "..guoData)                                            WebSocketClient.request(FightingData.operationCard("207",nil),function( ret )                                              retFunction(ret)                                            end)                                            -- playCardsOtherDirection(4)                                        end                                  end)          end        end        if data["commandType"] == 101 then          -- timerOfwhichOne(layBack,2,time)          -- 有暗杠的牌          local inGang = commandTypeTips["104"]          -- 胡牌提示          local finish = commandTypeTips["206"]          -- 听牌提示          local tinged = commandTypeTips["105"]            isTing = mycardVm["tinged"]          -- 过牌提示          local guo = commandTypeTips["207"]          -- 吃牌提示          local chi = commandTypeTips["102"]                    -- 碰牌提示          local peng = commandTypeTips["103"]          -- 吃听提示          local chiTing = commandTypeTips["106"]          -- 碰听提示          local pengTing = commandTypeTips["107"]          -- 听打提示          local tingDa = commandTypeTips["108"]          if finish ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 胡牌提示            ShowNotice.showShellInfo("胡了")            btnHu:setVisible(true)            playItemAnimation(btnHu)            print("胡了，哈哈哈哈哈哈哈哈哈哈哈")            btnHu:addTouchEventListener(function  (sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            hideAllBtn()                                            specialFlag = false                                            -- 吃听                                            ShowNotice.showShellInfo("已经胡了")                                            WebSocketClient.request(FightingData.operationCard("206"),function( ret )                                              retFunction(ret)                                            end)                                        end                                  end)          end          if inGang ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 有暗杠            ShowNotice.showShellInfo("暗杠")            btnGang:setVisible(true)            playItemAnimation(btnGang)                       btnGang:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            hideAllBtn()                                            AudioHelper.playCommonEffect()                                            ingangEffects = inGang["effects"]                                            -- 取出受影响的牌                                            local temp = ingangEffects[1]                                            standupCard(temp[1])                                            standupCard(temp[2],1)                                            standupCard(temp[3],2)                                            tishi.btnDa:setVisible(true)                                            tishi.btnDa:setTouchEnabled(true)                                            tishi.btnDa:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                          -- 是自己要暗杠                                                                            specialFlag = false                                                                            -- 点击音效                                                                            AudioHelper.playBtnEffect("gang_01.mp3")                                                                            WebSocketClient.request(FightingData.operationCard("104",temp),function( ret )                                                                              retFunction(ret)                                                                            end)                                                                            -- 处理暗杠操作                                                                            hideAllBtn()                                                                        end                                                                  end)                                            local index = 1                                            if #ingangEffects >1 then                                                tishi.btnTishi:setVisible(true)                                                tishi.btnTishi:setTouchEnabled(true)                                                tishi.btnTishi:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                           AudioHelper.playCommonEffect()                                                                            standDownCard(temp[1])                                                                            standDownCard(temp[2],1)                                                                            standDownCard(temp[3],2)                                                                            index = index + 1                                                                            if index <= #ingangEffects then                                                                               temp = ingangEffects[index]                                                                            else                                                                               temp = ingangEffects[1]                                                                               index = 1                                                                            end                                                                            standupCard(temp[1])                                                                            standupCard(temp[2],1)                                                                            standupCard(temp[3],2)                                                                        end                                                                  end)                                            end                                        end                                  end)            btnGang:setVisible(true)          end          if isTing == true then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            isTing = mycardVm["tinged"]          end          if tinged ~= nil  then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            myCards = mycardVm["cards"]            translateCards()            setupCards(layBack)             ShowNotice.showShellInfo("听牌")            btnTing:setVisible(true)            playItemAnimation(btnTing)            btnTing:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                         -- tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                            specialFlag = false                                            -- 点击音效                                            AudioHelper.playCommonEffect()                                           -- AudioHelper.playBtnEffect("ting_01.mp3")                                            WebSocketClient.request(FightingData.operationCard("105",nil), function ( ret )                                              retFunction(ret)                                            end)                                            hideAllBtn()                                        end                                  end)          end          if guo ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 过牌            ShowNotice.showShellInfo("过牌")            btnGuo:setVisible(true)            playItemAnimation(btnGuo)            btnGuo:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            -- 什么操作都不做                                            hideAllBtn()                                            if finish ~= nil then                                              huGuoFlag = true                                            end                                            AudioHelper.playCommonEffect()                                            specialFlag = false                                            WebSocketClient.request(FightingData.operationCard("207",nil),function( ret )                                              retFunction(ret)                                            end)                                            -- playCardsOtherDirection(4)                                        end                                  end)          end          if pengTing~=nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 碰听            ShowNotice.showShellInfo("碰听")            --hideAllBtn()            btnPentTing:setVisible(true)             playItemAnimation(btnPentTing)                        btnPentTing:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            hideAllBtn()                                            AudioHelper.playCommonEffect()                                            local pengArr = pengTing["effects"]                                            pengEffectCard = pengTing["effects"][1]                                            local temp = pengEffectCard["costCardIndexes"]                                            standupCard(temp[1])                                            standupCard(temp[2],1)                                            tishi.btnDa:setVisible(true)                                            tishi.btnDa:setTouchEnabled(true)                                            tishi.btnDa:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                          tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                                                          specialFlag = false                                                                          tingDaFlag = true                                                                          -- 点击音效                                                                          AudioHelper.playBtnEffect("peng_01.mp3")                                                                          -- 取出碰的信息                                                                          WebSocketClient.request(FightingData.operationCard("107",temp),function( ret )                                                                            retFunction(ret)                                                                          end)                                                                          hideAllBtn()                                                                        end                                                                  end)                                            local index = 1                                            if #pengArr >1 then                                                tishi.btnTishi:setVisible(true)                                                tishi.btnTishi:setTouchEnabled(true)                                                tishi.btnTishi:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                           AudioHelper.playCommonEffect()                                                                            standDownCard(temp[1])                                                                            standDownCard(temp[2],1)                                                                            index = index + 1                                                                            if index <= #pengArr then                                                                               pengEffectCard = pengTing["effects"][index]                                                                                temp = pengEffectCard["costCardIndexes"]                                                                                                                                                          else                                                                               pengEffectCard = pengTing["effects"][1]                                                                               temp = pengEffectCard["costCardIndexes"]                                                                               index = 1                                                                            end                                                                            standupCard(temp[1])                                                                            standupCard(temp[2],1)                                                                        end                                                                  end)                                            end                                             end                                  end)          end          if chiTing~=nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 吃听            ShowNotice.showShellInfo("吃听")            --hideAllBtn()            btnChiting:setVisible(true)             playItemAnimation(btnChiting)                        btnChiting:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            hideAllBtn()                                            AudioHelper.playCommonEffect()                                            local chiAryy = chiTing["effects"]                                            chiEffectCard = chiTing["effects"][1]                                            local temp = chiEffectCard["costCardIndexes"]                                            print("111"..temp[1].."222"..temp[2])                                            standupCard(temp[1])                                            standupCard(temp[2])                                            tishi.btnDa:setVisible(true)                                            tishi.btnDa:setTouchEnabled(true)                                            tishi.btnDa:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                          tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                                                          specialFlag = false                                                                          tingDaFlag = true                                                                          -- 点击音效                                                                          AudioHelper.playBtnEffect("chi_01.mp3")                                                                          WebSocketClient.request(FightingData.eatTingOne(temp), function ( ret )                                                                            retFunction(ret)                                                                          end)                                                                          hideAllBtn()                                                                        end                                                                  end)                                            local index = 1                                            if #chiAryy >1 then                                                tishi.btnTishi:setVisible(true)                                                tishi.btnTishi:setTouchEnabled(true)                                                tishi.btnTishi:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                           AudioHelper.playCommonEffect()                                                                            standDownCard(temp[1])                                                                            standDownCard(temp[2])                                                                            index = index + 1                                                                            if index <= #chiAryy then                                                                               chiEffectCard = chiTing["effects"][index]                                                                                temp = chiEffectCard["costCardIndexes"]                                                                            else                                                                               chiEffectCard = chiTing["effects"][1]                                                                               temp = chiEffectCard["costCardIndexes"]                                                                               index = 1                                                                            end                                                                            standupCard(temp[1])                                                                            standupCard(temp[2])                                                                        end                                                                  end)                                            end                                                                                    end                                  end)          end          if chi ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 吃牌            ShowNotice.showShellInfo("吃牌")            btnEat:setVisible(true)            playItemAnimation(btnEat)                        btnEat:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            hideAllBtn()                                            AudioHelper.playCommonEffect()                                         --  btnEat:setVisible(false)                                            chiEffectCard = chi["effects"]                                            local temp = chiEffectCard[1]                                            print("111"..temp[1].."222"..temp[2])                                            standupCard(temp[1])                                            standupCard(temp[2])                                            tishi.btnDa:setVisible(true)                                            tishi.btnDa:setTouchEnabled(true)                                            tishi.btnDa:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                         -- AudioHelper.playCommonEffect()                                                                              specialFlag = false                                                                              -- 点击音效                                                                              AudioHelper.playBtnEffect("chi_01.mp3")                                                                              WebSocketClient.request(FightingData.eatOne(temp), function ( ret )                                                                                retFunction(ret)                                                                              end)                                                                              hideAllBtn()                                                                        end                                                                  end)                                            local index = 1                                            if #chiEffectCard >1 then                                                tishi.btnTishi:setVisible(true)                                                tishi.btnTishi:setTouchEnabled(true)                                                tishi.btnTishi:addTouchEventListener(function  ( sender, eventType)                                                                        if (eventType == TOUCH_EVENT_ENDED) then                                                                           AudioHelper.playCommonEffect()                                                                            standDownCard(temp[1])                                                                            standDownCard(temp[2])                                                                            index = index + 1                                                                            if index <= #chiEffectCard then                                                                               temp = chiEffectCard[index]                                                                            else                                                                               temp = chiEffectCard[1]                                                                               index = 1                                                                            end                                                                            standupCard(temp[1])                                                                            standupCard(temp[2])                                                                        end                                                                  end)                                            end                                        end                                  end)          end          if tingDa ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 听打            ShowNotice.showShellInfo("听打")            btnTingda:setVisible(true)            playItemAnimation(btnTingda)            btnPeng:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                          tbZhuangtai.img_zhuangtai_ting_bottom:setVisible(true)                                            specialFlag = false                                            -- 点击音效                                            AudioHelper.playBtnEffect("ting_01.mp3")                                            WebSocketClient.request(FightingData.sendTingDaOne(tingDaOperateCards),function( ret )                                              retFunction(ret)                                            end)                                            hideAllBtn()                                        end                                  end)          end          if peng ~= nil then            specialFlag = true            print("修改specialFlag为true")            print("有特殊操作")            -- 碰牌            ShowNotice.showShellInfo("碰牌")            btnPeng:setVisible(true)            playItemAnimation(btnPeng)                        btnPeng:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                             hideAllBtn()                                             AudioHelper.playCommonEffect()                                             pengEffectCard = peng["effects"]                                             local temp = pengEffectCard[1]                                             standupCard(temp[1])                                             standupCard(temp[2],1)                                             tishi.btnDa:setVisible(true)                                             tishi.btnDa:setTouchEnabled(true)                                             tishi.btnDa:addTouchEventListener(function  ( sender, eventType)                                                                          if (eventType == TOUCH_EVENT_ENDED) then                                                                             specialFlag = false                                                                              -- 点击音效                                                                              AudioHelper.playBtnEffect("peng_01.mp3")                                                                              WebSocketClient.request(FightingData.operationCard("103",temp),function( ret )                                                                                retFunction(ret)                                                                              end)                                                                              hideAllBtn()                                                                          end                                                                    end)                                                                                      local index = 1                                              if #pengEffectCard >1 then                                                  tishi.btnTishi:setVisible(true)                                                  tishi.btnTishi:setTouchEnabled(true)                                                  tishi.btnTishi:addTouchEventListener(function  ( sender, eventType)                                                                          if (eventType == TOUCH_EVENT_ENDED) then                                                                             AudioHelper.playCommonEffect()                                                                              standDownCard(temp[1])                                                                              standDownCard(temp[2],1)                                                                              index = index + 1                                                                              if index <= #pengEffectCard then                                                                                 temp = pengEffectCard[index]                                                                              else                                                                                 temp = pengEffectCard[1]                                                                                 index = 1                                                                              end                                                                              standupCard(temp[1])                                                                              standupCard(temp[2],1)                                                                          end                                                                    end)                                              end                                        end                                  end)          end        end      end      if data["commandType"] == 100 then        -- 不是初始获取牌        -- 摸牌        -- local tempMyCards = myCards               isTing = mycardVm["tinged"]        if isTing and tingDaOperateCards[1]~=nil then          print("听打设置newOne")          newName= changeCardName(tingDaOperateCards[1])          -- table.insert(faceNameArray,#faceNameArray+1,name)                    newOne = getWord(newName)          newOne:setTag(12)          myCards = mycardVm["cards"]          myCards[tingDaOperateCards[1]+1] = myCards[tingDaOperateCards[1]+1]-1        else          myCards = mycardVm["cards"]        end        print("这是摸牌阶段")        translateCards()        setupCards(layBack)      end      if data["commandType"] == 101 or data["commandType"] == 108 then        print("打牌喽")        myCards = mycardVm["cards"]        isTing = mycardVm["tinged"]        local outUserId = data["userId"]        if outPosition ~= nil then          print(outUserId.." "..outPosition)        end        if start == false then          print("start 为 false")        else          print("start 为 true")        end        -- 或者刚开局时候        if outPosition ~= nil or start == true then          print("进来了111")          -- if start == true then            start = false            -- 收到别人打出的牌            local tempPlayerCardVm = otherPlayerCardVms[outUserId]            if tempPlayerCardVm == nil then              print("tempPlayerCardVm为空")            end            if tempPlayerCardVm ~= nil then              print("进来了222")              outPosition = tempPlayerCardVm["position"]              otherOutCards = tempPlayerCardVm["outCards"]              -- if tempPlayerCardVm["eatSequences"] ~= nil then              --   chiCardsArray = tempPlayerCardVm["eatSequences"]              -- end              -- if tempPlayerCardVm["pengSequences"] ~= nil then              --   pengCardsArray = tempPlayerCardVm["pengSequences"]              -- end              -- 计算位置              print("收到别人打出的牌 "..outPosition.." "..myPosition)              local disResult = (4 + outPosition - myPosition) % 4              if dis ~= 0 then                playCardsOtherDirection(disResult)              end              if disResult == 1 then                -- 右边                if tempPlayerCardVm["eatSequences"] ~= nil then                  rightChiArray = tempPlayerCardVm["eatSequences"]                end                if tempPlayerCardVm["pengSequences"] ~= nil then                  rightPengArray = tempPlayerCardVm["pengSequences"]                end              end              if disResult == 2 then                -- 上边                if tempPlayerCardVm["eatSequences"] ~= nil then                  upChiArray = tempPlayerCardVm["eatSequences"]                end                if tempPlayerCardVm["pengSequences"] ~= nil then                  upPengArray = tempPlayerCardVm["pengSequences"]                end              end              -- @warnning 要删除              if disResult == 3 then                if tempPlayerCardVm["eatSequences"] ~= nil then                  leftChiArray = tempPlayerCardVm["eatSequences"]                end                if tempPlayerCardVm["pengSequences"] ~= nil then                  leftPengArray = tempPlayerCardVm["pengSequences"]                end                -- 上一家打完，我摸牌                print("上一家打完，我摸牌")                if specialFlag == true then                  print("specialFlag为true")                else                  print("specialFlag为false")                end                if commandTypeTips == nil then                  print("我摸牌")                  playCardsOtherDirection(4)                end              end            end          -- end        end        if outPosition == nil then          if tonumber(outUserId) == tonumber(DataCache.getUserInfo().userId) then            -- 自己打出的牌            print("自己打出的牌")            outPosition = myPosition          end        end        if isTing == true then            translateCards()        --  end             setupCards(layBack)        end      end      -- 吃的操作      if data["commandType"] == 102 then        print("吃牌啦")        myCards = mycardVm["cards"]        local eatUserId = data["userId"]        print("userId "..eatUserId)        print("myUserid" ..DataCache.getUserInfo().userId)        if tonumber(eatUserId) == tonumber(DataCache.getUserInfo().userId) then          -- 自己吃牌          -- 取出受影响的所有牌          chiCardsArray = mycardVm["eatSequences"]          translateCards()           setupCards(layBack)        else           AudioHelper.playBtnEffect("chi_01.mp3")          -- 别人吃牌          ShowNotice.showShellInfo("玩家"..eatUserId.."吃了")          -- 取出别人吃牌的数据          local temp = otherPlayerCardVms[eatUserId]          local tempPosition = temp["position"]          local tempValue = tempPosition - myPosition          if tempValue == 1 or tempValue == -3 then            -- 右边那家            rightChiArray = temp["eatSequences"]          end          if tempValue == 2 or tempValue == -2 then            -- 上边那家            upChiArray = temp["eatSequences"]          end          if tempValue == 3 or tempValue == -1 then            -- 左边那家            leftChiArray = temp["eatSequences"]          end        end        -- 上面        setupLayer(layBack ,"lay_up" ,"b_05.png", 0, 2)        -- 左面        setupLayer(layBack, "lay_left", "b_03_2.png", -rotate, 3)        -- 右面        setupLayer(layBack, "lay_right", "b_03.png", rotate, 1)      end      -- 碰的操作      if data["commandType"] == 103 then        print("碰牌啦")        myCards = mycardVm["cards"]        local pengUserId = data["userId"]        print("userId "..pengUserId)        print("myUserid" ..DataCache.getUserInfo().userId)        if tonumber(pengUserId) == tonumber(DataCache.getUserInfo().userId) then          -- 自己碰牌          -- 取出受影响的所有牌          pengCardsArray = mycardVm["pengSequences"]          translateCards()           setupCards(layBack)        else           AudioHelper.playBtnEffect("peng_01.mp3")          -- 别人碰牌          ShowNotice.showShellInfo("玩家"..pengUserId.."碰了")          -- 取出别人碰牌啦的数据          local temp = otherPlayerCardVms[pengUserId]          local tempPosition = temp["position"]          local tempValue = tempPosition - myPosition          if tempValue == 1 or tempValue == -3 then            -- 右边那家            rightPengArray = temp["pengSequences"]          end          if tempValue == 2 or tempValue == -2 then            -- 上边那家            upPengArray = temp["pengSequences"]          end          if tempValue == 3 or tempValue == -1 then            -- 左边那家            leftPengArray = temp["pengSequences"]          end        end        -- 上面        setupLayer(layBack ,"lay_up" ,"b_05.png", 0,2)        -- 左面        setupLayer(layBack, "lay_left", "b_03_2.png", -rotate,3)        -- 右面        setupLayer(layBack, "lay_right", "b_03.png", rotate,1)      end      -- 杠的操作      if data["commandType"] == 104 then        print("杠牌啦")        myCards = mycardVm["cards"]        local gangUserId = data["userId"]        print("userId "..gangUserId)        print("myUserid" ..DataCache.getUserInfo().userId)        if tonumber(gangUserId) == tonumber(DataCache.getUserInfo().userId) then          -- 自己杠牌          ingangCardsArray = mycardVm["outGangCards"]          translateCards()          setupCards(layBack)        else          AudioHelper.playBtnEffect("gang_01.mp3")          -- 别人杠牌          ShowNotice.showShellInfo("玩家"..gangUserId.."杠了")          -- 取出杠人吃牌的数据          -- local orign = data["operateCards"]          local temp = otherPlayerCardVms[gangUserId]          local tempGang = temp["outGangCards"]          local tempPosition = temp["position"]          local tempValue = tempPosition - myPosition          -- table.insert(orign,1,tempGang[1])          -- local final = {}          -- final[1] = orign          if tempValue == 1 or tempValue == -3 then            -- 右边那家            rightGangArray = tempGang          end          if tempValue == 2 or tempValue == -2 then            -- 上边那家            upGangArray = tempGang          end          if tempValue == 3 or tempValue == -1 then            -- 左边那家            leftGangArray = tempGang          end          print("rightGangArray "..#rightGangArray)          print("upGangArray "..#upGangArray)          print("leftGangArray "..#leftGangArray)        end        -- 上面        setupLayer(layBack ,"lay_up" ,"b_05.png", 0,2)        -- 左面        setupLayer(layBack, "lay_left", "b_03_2.png", -rotate,3)        -- 右面        setupLayer(layBack, "lay_right", "b_03.png", rotate,1)      end      if data["commandType"] == 207 then        -- 过牌操作        print("有人过牌啦")        ShowNotice.showShellInfo("有人过了")        local guoUserId = data["userId"]        print("玩家"..guoUserId.."过牌了")        ShowNotice.showShellInfo("玩家"..guoUserId.."过牌了")        local nextOne = data["nextUserId"]        if tonumber(guoUserId) == tonumber(DataCache.getUserInfo().userId) then          myCards = mycardVm["cards"]          isTing = myCards["tinged"]          if isTing and tingDaOperateCards[1]~=nil then            print("听打设置newOne")            newName= changeCardName(tingDaOperateCards[1])            newOne = getWord(newName)            newOne:setTag(12)            myCards[tingDaOperateCards[1]+1] = myCards[tingDaOperateCards[1]+1]-1          end          translateCards()          setupCards(layBack)        end        if tonumber(nextOne) == tonumber(DataCache.getUserInfo().userId) then          playCardsOtherDirection(4)        end      end      commandTypeTips = nil      if data["commandType"] == 105 then        myCards = mycardVm["cards"]        translateCards()        setupCards(layBack)        print("我听牌了")        ShowNotice.showShellInfo("听")        local tempOp = data["operateCards"]        local operateCards = tempOp[1]        print("oprationCards "..operateCards)        standupCard(operateCards)        btnTingda:setVisible(true)        playItemAnimation(btnTingda)        tingDaFlag = true        btnTingda:addTouchEventListener(function  (sender, eventType)                                    if (eventType == TOUCH_EVENT_ENDED) then                                        specialFlag = false                                        -- 点击音效                                        -- AudioHelper.playBtnEffect("ting_01.mp3")                                          -- 取出碰的信息                                        local aryDatas = {}                                        aryDatas[1] = operateCards                                        local cardName = changeCardName(operateCards)                                        print("cardName"..cardName)                                        local count                                        for i=1,#faceNameArray do                                          if faceNameArray[i] == cardName then                                            count = i                                            break                                          end                                        end                                        playOutCards(count,1)                                        hideAllBtn()                                    end                              end)      end    end    commandTypeTips = nil  endend-- 设置界面，添加事件function setupCards(layBack)  -- 下面代码是添加正面麻将  if ingangCardsArray == nil then    ingangCardsArray = {}  end  if chiCardsArray == nil then    chiCardsArray = {}  end  if pengCardsArray == nil then    pengCardsArray = {}  end  local number = #ingangCardsArray * 4 + #chiCardsArray * 3 + #pengCardsArray * 3  for i=1,#cardsArray do    local layName = "lay_bottom_" .. i    -- print("layName"..layName)    local lay_bottom = m_fnGetWidget(layBack,layName)    local sprite = baseArray[i]    local face = cardsArray[i]    if i == 14 then      sprite:setPosition(ccp(lay_bottom:getContentSize().width/2+margin,lay_bottom:getContentSize().height*.5))    else      sprite:setPosition(ccp(lay_bottom:getContentSize().width/2,lay_bottom:getContentSize().height*.5))    end    -- sprite添加点击事件    lay_bottom:addTouchEventListener(function (sender,eventType)      -- 去除吃碰杠的数量      if i <= number then        return      end      if eventType == TOUCH_EVENT_BEGAN then        print("index is"..i)        currentSprite = baseArray[i]        currentFace = cardsArray[i]        if currentSprite == nil or currentFace == nil or currentFace == "empty" then          return        end        if isTing and newOne==nil  then          print("111---")          return        else        if isTing and i ~= #cardsArray then          print("222---"..i)          return        end        if tingDaFlag and i ~= 14 then          print("333---"..i)          return        end        end        -- 判断牌的位置        local x, y = currentSprite:getPosition()        local com = lay_bottom:getContentSize().height*.5        if y == com then          -- 不是上次选中的那张          -- 降下之前那张          if lastSprite ~= nil then            lastSprite:setPositionY(lay_bottom:getContentSize().height*.5)            lastFace:setPositionY(lay_bottom:getContentSize().height*.5-20)          end          -- 升起新的牌          print("往上移")          currentSprite:setPositionY(lay_bottom:getContentSize().height*.5+20)          currentFace:setPositionY(lay_bottom:getContentSize().height*.5-20+20)          -- 点击站起来的音效          AudioHelper.playTabEffect()          -- 记录选择的麻将          lastSprite = currentSprite          lastFace = currentFace          lastLayer = lay_bottom          choosenSprite = currentSprite          choosenFace = currentFace        else          print("准备打出去")          if canOut == false then            print("canOut 为空")          end          -- 判断能不能打          if canOut then            newOne = nil            lastSprite = nil            lastFace = nil            print("把麻将打出去")            if outPosition ~= nil then              outPosition = outPosition + 1              if outPosition > 3 then                outPosition = 0              end            end            canOut = false            choosenIndex = i            print("the choosen index is "..choosenIndex)            -- 打出麻将            if choosenSprite == nil then              print("333为空")            end            playOutCards()          end        end      end    end)    if face ~= "empty" then      if i == 14 then        face:setPosition(ccp(lay_bottom:getContentSize().width/2+margin,lay_bottom:getContentSize().height*.5 - 12))      else        face:setPosition(ccp(lay_bottom:getContentSize().width/2,lay_bottom:getContentSize().height*.5 - 12))      end      face:setScale(1.2)    end    if sprite:getParent() ~=nil then      sprite:removeFromParentAndCleanup(true)      if face ~= "empty" then        face:removeFromParentAndCleanup(true)      end    end    lay_bottom:addNode(sprite)        -- print("i "..i.."number "..number)    if i <= number then      sprite:setScale(2.1)      face:setPosition(ccp(lay_bottom:getContentSize().width/2,lay_bottom:getContentSize().height*.5))    else      sprite:setScale(1.8)    end    if isTing and i <= 13 then      sprite:setScale(2.1)      face:setPosition(ccp(lay_bottom:getContentSize().width/2,lay_bottom:getContentSize().height*.5))    end    if face ~= "empty" then      -- if newOne~=nil then         -- newOne:setVisible(false)         -- newOne = nil setOpacity      -- end      lay_bottom:addNode(face)    end  end    -- 上面代码是添加正面麻将  -- 添加另外三面的代码  -- 上面  setupLayer(layBack ,"lay_up" ,"b_05.png", 0, 2)  -- 左面  setupLayer(layBack, "lay_left", "b_03_2.png", -rotate,3)  -- 右面  setupLayer(layBack, "lay_right", "b_03.png", rotate,1)endfunction unscheduleScriptEntry( id )   if id then     CCDirector:sharedDirector():getScheduler():unscheduleScriptEntry(id)   endend-- 东，北，西三个方向打出牌-- @param direction 方向 12--北 3--西--东 function playCardsOtherDirection(direction)  local showBase = getWord("b_10.png")    if direction == 1 and outPosition ~= nil then         print("东边打出一张牌")        local rightBase = getWord("b_02.png")        local temp = otherOutCards[#otherOutCards]        print("11--"..temp)        local rightFaceName = changeCardName(temp,1)        print("东边打出"..rightFaceName)        local rightFace = getWord(rightFaceName)        local tempFace = getWord(changeCardName(temp))        layLastOutTable.lay_right_last_out:addNode(showBase)        layLastOutTable.lay_right_last_out:addNode(tempFace)        performWithDelay(layBack, function(...)          layLastOutTable.lay_right_last_out:removeAllNodes()        end,2)        lay_out_right:addNode(rightBase)        lay_out_right:addNode(rightFace)        rightBase:setZOrder(21-rightCount)        rightFace:setZOrder(21-rightCount)        local col_right = math.floor(rightCount / 10)        local row_right = rightCount % 10        local posX_right = col_right*68-8*row_right-22*col_right        local posY_right = row_right*48-28*row_right        rightBase:setPosition(ccp(posX_right,posY_right))        rightFace:setPosition(ccp(posX_right,posY_right+10))        rightCount = rightCount + 1        -- 东边打完，轮到北边        -- timerOfwhichOne(layBack,2,time)      end      if direction == 2 and outPosition ~= nil then        print("北边打出一张牌")        upBase = getWord("b_07.png")        local temp = otherOutCards[#otherOutCards]        print("11--"..temp)        local upFaceName = changeCardName(temp)        print("北边打出"..upFaceName)        local upFace = getWord(upFaceName)        local tempFace = getWord(upFaceName)        layLastOutTable.lay_up_last_out:addNode(showBase)        layLastOutTable.lay_up_last_out :addNode(tempFace)        performWithDelay(layBack, function(...)          layLastOutTable.lay_up_last_out:removeAllNodes()        end,2)        lay_out_up:addNode(upBase)        lay_out_up:addNode(upFace)        upBase:setZOrder(21-upCount)        upFace:setZOrder(21-upCount)        upFace:setScale(0.7)        local col_up = upCount % 10        local row_up = math.floor(upCount / 10)        local posX_up = col_up*48-5*col_up        local posY_up = row_up*68-20*row_up        upBase:setPosition(ccp(posX_up,posY_up))        upFace:setPosition(ccp(posX_up,posY_up))        upCount = upCount + 1        -- 北边打完，轮到西边        -- timerOfwhichOne(layBack,3,time)      end      if direction == 3 and outPosition ~= nil then        print("西边打出一张牌")        local leftBase = getWord("b_02_2.png")        local temp = otherOutCards[#otherOutCards]        print("11--"..temp)        local leftFaceName = changeCardName(temp,3)        print("西边打出"..leftFaceName)        local leftFace = getWord(leftFaceName)        local tempFace = getWord(changeCardName(temp))        layLastOutTable.lay_letf_last_out:addNode(showBase)        layLastOutTable.lay_letf_last_out:addNode(tempFace)        performWithDelay(layBack, function(...)          layLastOutTable.lay_letf_last_out:removeAllNodes()        end,2)        lay_out_left:addNode(leftBase)        lay_out_left:addNode(leftFace)        leftBase:setZOrder(21-leftCount)        leftFace:setZOrder(21-leftCount)        local col_left = math.floor(leftCount / 10)        local row_left = leftCount % 10        local posX_left = col_left*68+8*row_left-22*col_left        local posY_left = row_left*48-28*row_left        leftBase:setPosition(ccp(posX_left,posY_left))        leftFace:setPosition(ccp(posX_left,posY_left+10))        leftCount = leftCount + 1        -- 西边打完，下面轮到自己        -- timerOfwhichOne(layBack,4,time)      end      -- outPosition = nil      if direction == 4 then        if specialFlag == true then          print("specialFlag为true")        else          print("specialFlag为false")        end        -- if specialFlag == false then          print("轮到自己打牌了")          if #cardsArray < 14 then            -- 只有13张，需要摸牌            -- 摸牌请求            local getData = FightingData.getOne()            print("getData--"..getData)            WebSocketClient.request(getData,function ( ret )              -- body              print("收到了要打的牌")              canOut = true              retFunction(ret)            end)          end        -- end      endendfunction hideAllTimers( ... )  imgTimerOne:setVisible(false)  imgTimerTwo:setVisible(false)  imgTimerThree:setVisible(false)  imgTimerFour:setVisible(false)endfunction showDirection( direction )  if direction == 3 then    print("显示左边箭头")    hideAllTimers()    imgTimerOne:setVisible(true)  elseif direction == 4 then    print("显示我这边箭头")    hideAllTimers()    imgTimerTwo:setVisible(true)  elseif direction == 1 then    print("显示右边箭头")    hideAllTimers()    imgTimerThree:setVisible(true)   elseif direction == 2 then    print("显示上边箭头")    hideAllTimers()    imgTimerFour:setVisible(true)     endend--flag =3 显示左边的，4 显示下面的 1 显示右边的，2显示上面的function showTimer( layBack ,flag)  local time = 10  if flag == 3 then    hideAllTimers()    tfdTimerOne:setVisible(true)    imgTimerOne:setVisible(true)  elseif flag == 4 then    hideAllTimers()    tfdTimerTwo:setVisible(true)    imgTimerTwo:setVisible(true)  elseif flag == 1 then    hideAllTimers()    tfdTimerThree:setVisible(true)    imgTimerThree:setVisible(true)   elseif flag == 2 then    hideAllTimers()    tfdTimerFour:setVisible(true)    imgTimerFour:setVisible(true)     end    local function updateScheduler( ... )          labnCenter:setStringValue(time)          time = time - 1           print("round"..playCount)          if time < 0 then            time = 0            -- begin = begin + 1            -- if begin == 5 then                -- 这一轮结束，下一轮                -- begin = 1                if canOut then                 -- 我没有打牌                 -- 需要自动打出一张牌                 -- 自动打出牌组中的最后一张牌                 -- 打出牌                 print("自动打出一张牌")                 canOut = false                 playOutCards(#cardsArray)                end            -- end            unscheduleScriptEntry(schedulerId)            -- timerOfwhichOne(layBack,begin,maxTime)          end    end  schedulerId = CCDirector:sharedDirector():getScheduler():scheduleScriptFunc(updateScheduler, 1, false)end--界面中定时的东东，--layBack 父容器 --begin 从哪方开始计时 1 为东 逆时针到4  maxTime 秒为单位，计时的最大值    数字标签spritefunction timerOfwhichOne( layBack,begin,maxTime ) -- ArenaData.arenaScheduleId[1] = CCDirector:sharedDirector():getScheduler():scheduleScriptFunc(updateRewardTime, 1, false)    local labn --需要显示的数字标签    local time = maxTime    left_timer:setVisible(false)    right_timer:setVisible(false)    up_timer:setVisible(false)    bottom_timer:setVisible(false)        tfdLetfDir:setVisible(true)    tfdRightDir:setVisible(true)    tfdUpDir:setVisible(true)    tfdBottomDir:setVisible(true)    if begin == 1 then         right_timer:setVisible(true)        tfdRightDir:setVisible(false)        labn = labn_right    elseif begin == 2 then        up_timer:setVisible(true)         tfdUpDir:setVisible(false)        labn = labn_up    elseif begin == 3 then        left_timer:setVisible(true)        tfdLetfDir:setVisible(false)        labn = labn_left    else         canOut = true        bottom_timer:setVisible(true)        tfdBottomDir:setVisible(false)        labn = labn_bottom    end    local function updateScheduler( ... )          labn:setStringValue(time)          time = time - 1       --   time  = time +1          -- print(time)          print("round"..playCount)          if time < 0 then            time = 0            -- begin = begin + 1            -- if begin == 5 then                -- 这一轮结束，下一轮                -- begin = 1                if canOut then                 -- 我没有打牌                 -- 需要自动打出一张牌                 -- 自动打出牌组中的最后一张牌                 -- 打出牌                 print("自动打出一张牌")                 canOut = false                 playOutCards(#cardsArray)                end            -- end            unscheduleScriptEntry(schedulerId)            -- timerOfwhichOne(layBack,begin,maxTime)          end    end    schedulerId = CCDirector:sharedDirector():getScheduler():scheduleScriptFunc(updateScheduler, 1, false)endfunction backToMain( sender, eventType )  if (eventType == TOUCH_EVENT_ENDED) then        LayerManager.removeLayout()        require "script/module/mainTips/MainTipsCtrl"        local tips = MainTipsCtrl.create()        LayerManager.changeModule(tips, MainTipsCtrl.moduleName(), {1}, true)        unscheduleScriptEntry(schedulerId)  endendlocal function gameLoading() LayerManager.removeLayout() LayerManager.addLoadingByWait(function ()     local alert = UIHelper.createCommonDlg("继续等下去吗",nil,gameLoading,2,backToMain)     LayerManager.addLayout(alert,nil,g_tbTouchPriority.popDlg)  end)end-- 返回table中元素个数function retTableCount(table)  -- body  local num = 0  local count = 2  local tempOutPosition  -- print("json "..cjson.encode(table))  for i, v in pairs(table) do        num = num + 1       if type(v)=="table" then        playerInfoTable[count] = v      end      count = count + 1  end   return numendfunction ready( ... )    clearData()    clearLayer()    back:setVisible(true)    back:addTouchEventListener(backToMain)    WebSocketClient.request(FightingData.ready(),function ( ret )          local joinCheck = ret["ret"]          if joinCheck then              print("准备成功了")              retFunction(ret)          else             ShowNotice.showShellInfo("准备失败")          end    end)end-- 显示场景function create(tbEvent)  -- 最底的layer  layBack = g_fnLoadUI(activity_list)  --groupid   local btnGroupName = m_fnGetWidget(layBack,"btn_groupid")  btnGroupName:setTitleText("房间" .. FightingData.getGroupId())  btnGroupName:setTitleFontName(g_sFontName)    local IMG_BLACK = m_fnGetWidget(layBack, "img_back")    IMG_BLACK:setScale(g_fScaleX)  -- 下面打出的牌的layer  lay_out_bottom = m_fnGetWidget(layBack, "lay_out_bottom")  -- 右边  lay_out_right = m_fnGetWidget(layBack, "lay_out_right")  -- 上面  lay_out_up = m_fnGetWidget(layBack, "lay_out_up")  -- 左边  lay_out_left = m_fnGetWidget(layBack, "lay_out_left")  left_timer  = m_fnGetWidget(layBack,"LABN_TIP_LEFT") -- 西 3  right_timer = m_fnGetWidget(layBack,"LABN_TIP_RIGHT") --东 1  up_timer    = m_fnGetWidget(layBack,"LABN_TIP_UP") --北  2  bottom_timer= m_fnGetWidget(layBack,"LABN_TIP") -- 南  4  labn_bottom = m_fnGetWidget(layBack,"LABN_TIP")  labn_up     = m_fnGetWidget(layBack,"LABN_TIP_UP")  labn_up:setZOrder(100)  labn_right  = m_fnGetWidget(layBack,"LABN_TIP_RIGHT")  labn_left     = m_fnGetWidget(layBack,"LABN_TIP_LEFT")    tfdTimerOne = m_fnGetWidget(layBack,"tfd_dir_one")  tfdTimerTwo = m_fnGetWidget(layBack,"tfd_dir_four")  tfdTimerThree = m_fnGetWidget(layBack,"tfd_dir_two")  tfdTimerFour = m_fnGetWidget(layBack,"tfd_dir_three")  imgTimerOne = m_fnGetWidget(layBack,"img_dir_one")   imgTimerTwo = m_fnGetWidget(layBack,"img_dir_four")  imgTimerThree= m_fnGetWidget(layBack,"img_dir_two")  imgTimerFour= m_fnGetWidget(layBack,"img_dir_three")  labnCenter = m_fnGetWidget(layBack,"labn_tip_center")  back  = m_fnGetWidget(layBack,"btn_back") back:addTouchEventListener(backToMain)  back:setVisible(true)  tfdLetfDir  = m_fnGetWidget(layBack,"tfd_letf_dir")  tfdRightDir = m_fnGetWidget(layBack,"tfd_right_dir")  tfdUpDir    = m_fnGetWidget(layBack,"tfd_up_dir")  tfdBottomDir= m_fnGetWidget(layBack,"tfd_bottom_dir")  tfdLetfDir:setText("南")  tfdRightDir:setText("北")  tfdUpDir:setText("西")  tfdBottomDir:setText("东")  btnEat    = m_fnGetWidget(layBack,"btn_eat")  btnHu     = m_fnGetWidget(layBack,"btn_hu")  btnTing   = m_fnGetWidget(layBack,"btn_ting")  btnPeng   = m_fnGetWidget(layBack,"btn_peng")  btnGang  = m_fnGetWidget(layBack,"btn_gang")  btnGuo  = m_fnGetWidget(layBack,"btn_guo")  btnChiting  = m_fnGetWidget(layBack,"btn_chiting")  btnPentTing = m_fnGetWidget(layBack,"btn_pengting")  btnTingda  = m_fnGetWidget(layBack,"btn_tingda")  tishi.btnTishi  = m_fnGetWidget(layBack,"btn_tishi")  tishi.btnTishi:setTouchEnabled(false)  tishi.btnDa  = m_fnGetWidget(layBack,"btn_da")  tishi.btnTishi:setVisible(false)   tishi.btnDa:setVisible(false)   tishi.btnDa:setTouchEnabled(false)  tfdrightuser = m_fnGetWidget(layBack,"tfd_right_user")  tfdrightuser:setVisible(false)  tfdrightuser:setFontSize(30)  tfdupuser = m_fnGetWidget(layBack,"tfd_up_user")  tfdupuser:setVisible(false)  tfdupuser:setFontSize(30)  tfdleftuser = m_fnGetWidget(layBack,"tfd_left_user")  tfdleftuser:setVisible(false)  tfdleftuser:setFontSize(30)  btnChat = m_fnGetWidget(layBack,"btn_chat")  local imgChat = m_fnGetWidget(layBack,"img_chat_text")  --local tfdSendText = m_fnGetWidget(layBack,"tfd_left_user_chat")  chatTable.lay_letf_user_talk = m_fnGetWidget(layBack,"tfd_left_user_chat")  chatTable.layRightUserTalk  = m_fnGetWidget(layBack,"tfd_user_right_talk")  chatTable.layUpUserTalk   = m_fnGetWidget(layBack,"tfd_up_user_talk") -- local layLeftBackChat,layUpBackChat,layRightBackChat  chatTable.layLeftBackChat = m_fnGetWidget(layBack,"lay_letf_user_talk")  chatTable.layUpBackChat = m_fnGetWidget(layBack,"lay_up_user_talk")  chatTable.layRightBackChat = m_fnGetWidget(layBack,"lay_user_right_talk")  chatTable.lay_bottom_user_talk = m_fnGetWidget(layBack,"lay_bottom_user_talk")  chatTable.tfd_bottom_user_chat = m_fnGetWidget(layBack,"tfd_bottom_user_chat")  lay_baopai = m_fnGetWidget(layBack,"lay_baopai")  img_baopai_info = m_fnGetWidget(layBack,"img_baopai_info")  lay_baopai:setVisible(false)  img_left_user = m_fnGetWidget(layBack,"img_letf_user")  img_left_user:setVisible(false)  img_up_user = m_fnGetWidget(layBack,"img_up_user")  img_up_user:setVisible(false)  img_right_user = m_fnGetWidget(layBack,"img_right_user")  img_right_user:setVisible(false)  tbZhuangtai.img_zhuangtai_ting_left = m_fnGetWidget(layBack,"img_zhuangtai_ting_letf")  tbZhuangtai.img_zhuangtai_ting_up = m_fnGetWidget(layBack,"img_zhuangtai_ting_up")  tbZhuangtai.img_zhuangtai_ting_right = m_fnGetWidget(layBack,"img_zhuangtai_ting_right")  tbZhuangtai.img_zhuangtai_ting_bottom = m_fnGetWidget(layBack,"img_zhuangtai_ting_bottom")  tbZhuangtai.img_zhuangtai_zhuang_left = m_fnGetWidget(layBack,"img_zhuangtai_zhuang_left")  tbZhuangtai.img_zhuangtai_zhuang_up = m_fnGetWidget(layBack,"img_zhuangtai_zhuang_up")  tbZhuangtai.img_zhuangtai_zhuang_right = m_fnGetWidget(layBack,"img_zhuangtai_zhuang_right")  tbZhuangtai.img_zhuangtai_zhuang_bottom = m_fnGetWidget(layBack,"img_zhuangtai_zhuang_bottom")  layLastOutTable.lay_letf_last_out = m_fnGetWidget(layBack,"lay_letf_last_out")  layLastOutTable.lay_up_last_out = m_fnGetWidget(layBack,"lay_up_last_out")  layLastOutTable.lay_right_last_out = m_fnGetWidget(layBack,"lay_right_last_out")  chatTable.layLeftBackChat:setVisible(false)  chatTable.layUpBackChat:setVisible(false)  chatTable.layRightBackChat:setVisible(false)  -- chatTable.lay_letf_user_talk:setVisible(false)  -- chatTable.layUpUserTalk:setVisible(false)  -- chatTable.layRightUserTalk:setVisible(false)  -- chatTable.tfd_bottom_user_chat:setVisible(false)  chatTable.lay_bottom_user_talk:setVisible(false)  imgChat:setAnchorPoint(ccp(0, 0.5))  local size = imgChat:getSize()  local _editBoxText = UIHelper.createEditBox(size,"n_ui/login_text_bg.png",false)  _editBoxText:setAnchorPoint(ccp(0, 0.5))  _editBoxText:setPlaceHolder("输入想说的话")  _editBoxText:setReturnType(kKeyboardReturnTypeDone)  _editBoxText:setTouchPriority(g_tbTouchPriority.editbox)    -- _editBoxText:setEnabled(false)    -- _editBoxText:setTouchEnabled(false)  imgChat:addNode(_editBoxText )  imgChat:setVisible(false)  btnChat:setVisible(false)  btnChat:setTag(1)  btnChat:addTouchEventListener(function  ( sender, eventType)                                        if (eventType == TOUCH_EVENT_ENDED) then                                            local tag = btnChat:getTag()                                            if tag == 1 then -- 没有输入框，需要显示输入框，并把字写成发送                                                btnChat:setTag(2)                                                 btnChat:setTitleText("发送")                                                imgChat:setVisible(true)                                            else -- 有输入框                                                btnChat:setTag(1)                                                 btnChat:setTitleText("聊天")                                                imgChat:setVisible(false)                                                if _editBoxText:getText()~=nil and _editBoxText:getText()~="" then                                                   -- tfdSendText:setText(_editBoxText:getText())                                                    local  sendData = FightingData.gameMessage(_editBoxText:getText())                                                    _editBoxText:setText("")                                                   -- showChatForTime(lay_letf_user_talk,3)                                                    WebSocketClient.request(sendData,function ( ret )                                                                            -- body                                                                            -- messageGet(ret["data"])                                                                           retFunction(ret)                                                                            -- messageShow(ret)                                                                          end)                                                end                                            end                                        end                                  end)  for i=1,14 do    local layName = "lay_bottom_" .. i    print("layName"..layName)    local lay_bottom = m_fnGetWidget(layBack,layName)    table.insert(layoutArray,i,lay_bottom)  end  -- if FightingData.getXulian() ~= nil   then  --     retFunction(FightingData.getXulian())  --     FightingData.setXulian(nil)  -- else  if(FightingData.getIsReady == true) then      ready()      FightingData.setIsReady(false)  else    if FightingData.getXulian() ~= nil then        WebSocketClient.request("",function ( ret )             -- retFunction(ret)            print("续连")            if FightingData.getXulian() ~= nil then              retFunction(FightingData.getXulian())              FightingData.setXulian(nil)            else              retFunction(ret)            end          end)    else      require "script/module/room/MainCreatRoomView"      local joinData = FightingData.joinGame( FightingData.getPw())      print("joinData" .. joinData)      WebSocketClient.request(joinData,function ( ret )        local joinCheck = ret["ret"]        if joinCheck then            print("加入房间成功了")            retFunction(ret)        else           ShowNotice.showShellInfo("加入房间失败")        end      end)     end  end -- end -- retFunction(FightingData.getRet())  -- translateCards()   -- timerOfwhichOne(layBack,1,5)  -- 麻将布局  -- setupCards(layBack)  return layBackend